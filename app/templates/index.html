{% extends "base.html" %}

{% block title %}📊 דשבורד - Retail BI{% endblock %}

{% block content %}
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="page-header mb-4">
            <h1 class="display-4">
                <i class="bi bi-speedometer2"></i> דשבורד BI
            </h1>
            <p class="lead">ניתוח נתוני מכירות, רווחיות ומלאי בזמן אמת</p>
            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-success" onclick="exportToCSV()">
                    <i class="bi bi-download"></i> ייצא ל-CSV
                </button>
                <button class="btn btn-primary" onclick="shareDashboard()">
                    <i class="bi bi-share"></i> שתף דשבורד
                </button>
                {% if session.get('role') == 'store_manager' %}
                <div class="alert alert-info mb-0 d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <small>אתה רואה רק את נתוני הסניף שלך (סניף {{ session.get('store_id') }})</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Filters Panel (below header) -->
        <section class="filters-panel">
            <div class="filters-header">
                <div class="filters-title">
                    <i class="bi bi-funnel"></i> מסננים
                </div>
                <div class="filters-actions">
                    <button class="btn btn-primary" onclick="loadDashboard()">
                        <i class="bi bi-arrow-clockwise"></i> עדכן דשבורד
                    </button>
                </div>
            </div>
            <div class="filters-grid">
                <div class="filter-card">
                    <div class="filter-label">טווח תאריכים</div>
                    <div class="filter-row">
                        <div class="filter-field">
                            <label for="date_start">תאריך התחלה</label>
                            <input type="date" id="date_start" />
                        </div>
                        <div class="filter-field">
                            <label for="date_end">תאריך סיום</label>
                            <input type="date" id="date_end" />
                        </div>
                    </div>
                </div>

                <div class="filter-card">
                    <div class="filter-label">סניפים</div>
                    <select id="stores" multiple size="5"></select>
                    <div class="filter-hint">ניתן לבחור כמה סניפים</div>
                </div>

                <div class="filter-card">
                    <div class="filter-label">קטגוריות</div>
                    <select id="categories" multiple size="5"></select>
                    <div class="filter-hint">ניתן לבחור כמה קטגוריות</div>
                </div>

                <div class="filter-card">
                    <div class="filter-label">אזורים</div>
                    <select id="regions" multiple size="5"></select>
                    <div class="filter-hint">ניתן לבחור כמה אזורים</div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <main class="main-content">
            <!-- KPI Cards -->
            <section class="section">
                <h2>💰 מדדי ביצוע מרכזיים (KPIs)</h2>
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <h3>סך הכנסות</h3>
                        <div class="kpi-value" id="total_revenue">₪0</div>
                    </div>
                    <div class="kpi-card">
                        <h3>סך רווח</h3>
                        <div class="kpi-value" id="total_profit">₪0</div>
                    </div>
                    <div class="kpi-card">
                        <h3>שולי רווח</h3>
                        <div class="kpi-value" id="profit_margin">0%</div>
                    </div>
                    <div class="kpi-card">
                        <h3>ערך הזמנה ממוצע</h3>
                        <div class="kpi-value" id="avg_order_value">₪0</div>
                    </div>
                    <div class="kpi-card">
                        <h3>סך עסקאות</h3>
                        <div class="kpi-value" id="total_transactions">0</div>
                    </div>
                </div>
            </section>

            <!-- Sales Trends -->
            <section class="section">
                <h2>📈 מגמות מכירות</h2>
                <div class="chart-container">
                    <div id="revenue-trend" class="chart"></div>
                    <div id="profit-trend" class="chart"></div>
                </div>
            </section>

            <!-- Store Performance -->
            <section class="section">
                <h2>🏪 ביצועי סניפים</h2>
                <div class="chart-container">
                    <div id="store-revenue" class="chart"></div>
                    <div id="store-margin" class="chart"></div>
                </div>
                <div id="store-table" class="table-container"></div>
            </section>

            <!-- Product Performance -->
            <section class="section">
                <h2>📦 ניתוח מוצרים וקטגוריות</h2>
                <div class="chart-container">
                    <div id="top-products" class="chart"></div>
                    <div id="category-revenue" class="chart"></div>
                </div>
            </section>

            <!-- Customer Insights -->
            <section class="section">
                <h2>👥 תובנות לקוחות</h2>
                <div class="chart-container">
                    <div id="age-revenue" class="chart"></div>
                    <div id="gender-revenue" class="chart"></div>
                </div>
            </section>

            <!-- Inventory Management -->
            <section class="section">
                <h2>📦 ניהול מלאי חכם</h2>
                <div class="inventory-controls">
                    <div class="inventory-control-group">
                        <label>תקופת ניתוח (ימים):</label>
                        <select id="inventory-days" onchange="loadInventoryInsights()">
                            <option value="30">30</option>
                            <option value="60" selected>60</option>
                            <option value="90">90</option>
                        </select>
                    </div>
                    <div class="inventory-control-group">
                        <label>זמן אספקה (ימים):</label>
                        <select id="inventory-lead-time" onchange="loadInventoryInsights()">
                            <option value="5">5</option>
                            <option value="7" selected>7</option>
                            <option value="14">14</option>
                        </select>
                    </div>
                    <button class="btn btn-outline-primary" onclick="loadInventoryInsights()">
                        <i class="bi bi-arrow-clockwise"></i> עדכן מלאי
                    </button>
                </div>

                <div class="inventory-cards">
                    <div class="inventory-card">
                        <div class="inventory-card-title">פריטים מתחת לנקודת הזמנה</div>
                        <div class="inventory-card-value" id="low-stock-count">0</div>
                    </div>
                    <div class="inventory-card">
                        <div class="inventory-card-title">הזמנות מוצעות</div>
                        <div class="inventory-card-value" id="suggested-orders-count">0</div>
                    </div>
                    <div class="inventory-card">
                        <div class="inventory-card-title">EOQ ממוצע</div>
                        <div class="inventory-card-value" id="avg-eoq">0</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div id="inventory-reorder-chart" class="chart"></div>
                    <div id="inventory-availability-chart" class="chart"></div>
                </div>

                <div class="table-container" id="inventory-table"></div>
            </section>

            <!-- Seasonal Analysis -->
            <section class="section">
                <h2>📅 ניתוח עונתי</h2>
                <div class="chart-container">
                    <div id="quarterly-trend" class="chart"></div>
                    <div id="monthly-pattern" class="chart"></div>
                </div>
                <div id="seasonal-insights" class="insights-box"></div>
            </section>

            <!-- Sales Forecasting -->
            <section class="section">
                <h2>🔮 חיזוי מכירות</h2>
                <div class="forecast-controls">
                    <label>מספר חודשים לחיזוי:</label>
                    <select id="forecast-months" onchange="loadForecast()">
                        <option value="3">3 חודשים</option>
                        <option value="6" selected>6 חודשים</option>
                        <option value="12">12 חודשים</option>
                    </select>
                </div>
                <div id="forecast-chart" class="chart" style="min-height: 500px;"></div>
                <div id="forecast-accuracy" class="accuracy-box"></div>
            </section>
        </main>
{% endblock %}

{% block extra_scripts %}
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script>
        // Export to CSV functionality
        async function exportToCSV() {
            const filters = getFilters();
            const queryString = buildQueryString(filters);
            
            try {
                const response = await fetch(`/api/export-csv?${queryString}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `retail_bi_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('שגיאה בייצוא הנתונים');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('שגיאה בייצוא הנתונים');
            }
        }

        // Share dashboard functionality
        function shareDashboard() {
            const filters = getFilters();
            const params = new URLSearchParams();
            if (filters.dateStart) params.append('date_start', filters.dateStart);
            if (filters.dateEnd) params.append('date_end', filters.dateEnd);
            if (filters.stores) params.append('stores', filters.stores);
            if (filters.categories) params.append('categories', filters.categories);
            if (filters.regions) params.append('regions', filters.regions);
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Retail BI Dashboard',
                    text: 'צפה בדשבורד BI',
                    url: shareUrl
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('הקישור הועתק ללוח!');
                });
            }
        }
    </script>
{% endblock %}

